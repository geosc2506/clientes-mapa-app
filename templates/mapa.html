<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Mapa de Clientes</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <style>
    body {
      margin: 0;
      padding: 0;
      font-family: Arial, sans-serif;
      color: #fff;
      background: url("/static/images/fondo-cubos.jpg") no-repeat center center fixed;
      background-size: cover;
      background-color: #000;
    }
    #map {
      height: 65vh;
      margin: 10px;
      border-radius: 8px;
    }
    #filtros {
      margin: 10px;
      background: rgba(0, 0, 0, 0.4);
      border-radius: 8px;
      overflow: hidden;
    }
    #filtros summary {
      font-size: 16px;
      font-weight: bold;
      background: #222;
      color: #fff;
      padding: 10px;
      border-radius: 6px;
      cursor: pointer;
    }
    #filtros[open] .contenedor-filtros {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 6px;
      padding: 10px;
    }
    #filtros label {
      font-size: 12px;
      margin-bottom: 2px;
      display: block;
    }
    #filtros select,
    #filtros button {
      padding: 3px 6px;
      font-size: 13px;
      border-radius: 4px;
      min-height: 30px;
      width: 100%;
      box-sizing: border-box;
    }
    #filtros .botones {
      grid-column: span 2;
      display: flex;
      gap: 6px;
    }

    #lista-clientes {
      background: #111;
      padding: 15px;
      margin: 10px;
      border-radius: 8px;

      /* Barra de scroll en todos los tama√±os */
      max-height: 30vh;
      overflow-y: auto;
    }

    #lista-clientes::-webkit-scrollbar {
      width: 12px;
    }
    #lista-clientes::-webkit-scrollbar-track {
      background: #222;
      border-radius: 6px;
    }
    #lista-clientes::-webkit-scrollbar-thumb {
      background-color: #888;
      border-radius: 6px;
      border: 2px solid #222;
    }
    #lista-clientes::-webkit-scrollbar-thumb:hover {
      background-color: #aaa;
    }

    .cliente {
      background: #222;
      padding: 10px;
      margin-bottom: 10px;
      border-radius: 5px;
    }
    .cliente button {
      background-color: #2196F3;
      color: white;
      border: none;
      padding: 5px 10px;
      margin-top: 5px;
      cursor: pointer;
    }
    .top-bar {
      margin: 10px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-wrap: wrap;
    }
    .logout-btn {
      color: white;
      background: #e53935;
      padding: 6px 12px;
      border-radius: 5px;
      text-decoration: none;
      font-size: 14px;
    }

    /* Responsive: en m√≥vil ‚Üí lista m√°s alta, con scroll */
    @media (max-width: 768px) {
      #map {
        height: 50vh;
      }
      #lista-clientes {
        max-height: 40vh;
        overflow-y: auto;
      }
    }
  </style>
</head>
<body>

<div class="top-bar">
  <h3>üìç Mapa de clientes</h3>
  <a href="/logout" class="logout-btn">Cerrar sesi√≥n</a>
</div>

<details id="filtros" open>
  <summary>üîç Filtros de b√∫squeda</summary>
  <div class="contenedor-filtros">
    <label>Radio:</label>
    <select id="rango">
      <option value="500">500 metros</option>
      <option value="1000">1 kil√≥metro</option>
      <option value="2000">2 kil√≥metros</option>
    </select>

    <label>Estado:</label>
    <select id="estado">
      <option value="todos">Todos</option>
      <option value="activo">Activo</option>
      <option value="no activo">No activo</option>
    </select>

    <label>Prioridad:</label>
    <select id="prioridad">
      <option value="todos">Todos</option>
      {% for p in prioridades %}
      <option value="{{ p }}">{{ p }}</option>
      {% endfor %}
    </select>

    <label>Procesal:</label>
    <select id="procesal">
      <option value="todos">Todos</option>
      {% for p in procesales %}
      <option value="{{ p }}">{{ p }}</option>
      {% endfor %}
    </select>

    <label>Contactabilidad:</label>
    <select id="contactabilidad">
      <option value="todos">Todos</option>
      {% for c in contactabilidades %}
      <option value="{{ c }}">{{ c }}</option>
      {% endfor %}
    </select>

    <label>Negocio:</label>
    <select id="negocio">
      <option value="todos">Todos</option>
      {% for n in negocios %}
      <option value="{{ n }}">{{ n }}</option>
      {% endfor %}
    </select>

    <div class="botones">
      <button onclick="reiniciarUbicacion()">üìç Mi ubicaci√≥n</button>
      <button onclick="limpiar()">üßπ Limpiar</button>
    </div>
  </div>
</details>

<div id="map"></div>
<div id="lista-clientes"><strong>Clientes cercanos:</strong></div>

<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script>
const clientes = {{ clientes | tojson | safe }};
const map = L.map('map').setView([-12.0464, -77.0428], 13);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);

let marcadorUsuario = null;
let circulo = null;
let centroActual = [-12.0464, -77.0428];

function limpiar() {
  map.eachLayer(layer => {
    if (layer instanceof L.Marker && layer !== marcadorUsuario) {
      map.removeLayer(layer);
    }
  });
  if (circulo) map.removeLayer(circulo);

  document.getElementById("rango").selectedIndex = 0;
  document.getElementById("estado").value = "todos";
  document.getElementById("prioridad").value = "todos";
  document.getElementById("procesal").value = "todos";
  document.getElementById("contactabilidad").value = "todos";
  document.getElementById("negocio").value = "todos";

  document.getElementById("lista-clientes").innerHTML = "<strong>Clientes cercanos:</strong>";

  reiniciarUbicacion();
}

function colorPorPrioridad(prioridad) {
  switch ((prioridad || "").toLowerCase()) {
    case "alta": return 'red';
    case "media": return 'orange';
    case "baja": return 'blue';
    default: return 'gray';
  }
}

function mostrarClientes(centro, radio) {
  map.eachLayer(layer => {
    if (layer instanceof L.Marker && layer !== marcadorUsuario) {
      map.removeLayer(layer);
    }
  });
  if (circulo) map.removeLayer(circulo);

  centroActual = centro;

  const estadoFiltro = document.getElementById("estado").value.toLowerCase();
  const prioridadFiltro = document.getElementById("prioridad").value.toLowerCase();
  const procesalFiltro = document.getElementById("procesal").value.toLowerCase();
  const contactabilidadFiltro = document.getElementById("contactabilidad").value.toLowerCase();
  const negocioFiltro = document.getElementById("negocio").value.toLowerCase();

  let html = "<strong>Clientes cercanos:</strong>";
  let contador = 0;

  clientes.forEach(c => {
    const lat = Number(c.latitud);
    const lng = Number(c.longitud);
    if (!lat || !lng || isNaN(lat) || isNaN(lng)) return;

    const dist = map.distance(centro, [lat, lng]);
    const coincide =
      (estadoFiltro === "todos" || (c.estado || "").toLowerCase() === estadoFiltro) &&
      (prioridadFiltro === "todos" || (c.prioridad || "").toLowerCase() === prioridadFiltro) &&
      (procesalFiltro === "todos" || (c.procesal || "").toLowerCase() === procesalFiltro) &&
      (contactabilidadFiltro === "todos" || (c.contactabilidad || "").toLowerCase() === contactabilidadFiltro) &&
      (negocioFiltro === "todos" || (c.negocio || "").toLowerCase() === negocioFiltro);

    if (dist <= radio && coincide) {
      try {
        const icono = L.icon({
          iconUrl: `https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-${colorPorPrioridad(c.prioridad)}.png`,
          shadowUrl: 'https://unpkg.com/leaflet@1.7.1/dist/images/marker-shadow.png',
          iconSize: [25, 41],
          iconAnchor: [12, 41],
          popupAnchor: [1, -34],
          shadowSize: [41, 41]
        });

        const marker = L.marker([lat, lng], { icon: icono })
          .addTo(map)
          .bindPopup(`<b>${c.nombre}</b><br>${c.direccion || ''}`);

        html += `
          <div class="cliente">
            <b>${c.nombre}</b><br>
            <p><strong>ID Deudor:</strong> ${c.id_deudor ? c.id_deudor : 'Sin ID disponible'}</p>
            <p><strong>Direcci√≥n:</strong> ${c.direccion || ''}, ${c.distrito || ''}</p>
            <p><strong>Prioridad:</strong> ${c.prioridad || '-'}</p>
            <p><strong>Procesal:</strong> ${c.procesal || '-'}</p>
            <p><strong>Contactabilidad:</strong> ${c.contactabilidad || '-'}</p>
            <p><strong>Negocio:</strong> ${c.negocio || '-'}</p>
            <p><strong>Asesor:</strong> ${c.asesor || '-'}</p>
            <p><strong>Tel√©fono Asesor:</strong> ${c.nro_asesor || '-'}</p>
            <button onclick="centrarEnCliente(${lat}, ${lng})">üìç Ver en el mapa</button>
          </div>`;

        contador++;
      } catch (error) {
        console.warn("‚ùå No se pudo crear marcador para:", c.nombre, error);
      }
    }
  });

  if (contador === 0) {
    html += "<p>Sin resultados dentro del radio.</p>";
  }

  document.getElementById("lista-clientes").innerHTML = html;
  dibujarCirculo(centro, radio);
}

function centrarEnCliente(lat, lng) {
  map.setView([lat, lng], 16);
}

function dibujarCirculo(centro, radio) {
  if (circulo) map.removeLayer(circulo);
  circulo = L.circle(centro, {
    radius: radio,
    color: 'blue',
    fillColor: '#2196F3',
    fillOpacity: 0.2
  }).addTo(map);
}

function iniciarMapa() {
  navigator.geolocation.getCurrentPosition(pos => {
    const centro = [pos.coords.latitude, pos.coords.longitude];
    const radio = parseInt(document.getElementById("rango").value);
    if (marcadorUsuario) map.removeLayer(marcadorUsuario);
    marcadorUsuario = L.marker(centro).addTo(map).bindPopup("T√∫ est√°s aqu√≠").openPopup();
    map.setView(centro, 14);
    mostrarClientes(centro, radio);
  }, () => {
    alert("No se pudo obtener tu ubicaci√≥n.");
  });
}

function reiniciarUbicacion() {
  iniciarMapa();
}

["rango", "estado", "prioridad", "procesal", "contactabilidad", "negocio"].forEach(id => {
  document.getElementById(id).addEventListener("change", () => {
    const radio = parseInt(document.getElementById("rango").value);
    mostrarClientes(centroActual, radio);
  });
});

map.on("click", e => {
  const centro = [e.latlng.lat, e.latlng.lng];
  const radio = parseInt(document.getElementById("rango").value);
  if (marcadorUsuario) map.removeLayer(marcadorUsuario);
  marcadorUsuario = L.marker(centro).addTo(map).bindPopup("Ubicaci√≥n seleccionada").openPopup();
  mostrarClientes(centro, radio);
});

iniciarMapa();
</script>

</body>
</html>
