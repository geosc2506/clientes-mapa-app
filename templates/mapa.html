<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Mapa de clientes</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <style>
    body {
      background-color: #111;
      color: white;
      font-family: sans-serif;
    }
    #map {
      height: 70vh;
      margin: 10px auto;
      width: 95%;
      border-radius: 8px;
    }
    #filtros {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      align-items: center;
      margin: auto;
      padding: 10px;
      width: 95%;
    }
    #filtros select, #filtros button {
      padding: 5px;
      border-radius: 5px;
    }
    #lista-clientes {
      width: 95%;
      margin: auto;
      background-color: rgba(0, 0, 0, 0.9);
      padding: 10px;
      border-radius: 8px;
    }
    .cliente {
      margin-bottom: 10px;
      border-bottom: 1px solid #444;
      padding-bottom: 10px;
    }
    .cliente button {
      background-color: #3498db;
      color: white;
      border: none;
      padding: 5px 10px;
      border-radius: 4px;
      cursor: pointer;
    }
  </style>
</head>
<body>

<h3 style="text-align:center">📍 Mapa de clientes</h3>

<div id="filtros">
  <label>Radio:</label>
  <select id="rango">
    <option value="500">500 metros</option>
    <option value="1000" selected>1 kilómetro</option>
    <option value="2000">2 kilómetros</option>
    <option value="5000">5 kilómetros</option>
  </select>

  <label>Estado:</label>
  <select id="estado">
    <option value="todos">Todos</option>
    <option value="activo">Activo</option>
    <option value="no activo">No activo</option>
  </select>

  <label>Prioridad:</label>
  <select id="prioridad">
    <option value="todos">Todos</option>
    {% for p in prioridades %}
    <option value="{{ p }}">{{ p }}</option>
    {% endfor %}
  </select>

  <label>Procesal:</label>
  <select id="procesal">
    <option value="todos">Todos</option>
    {% for p in procesales %}
    <option value="{{ p }}">{{ p }}</option>
    {% endfor %}
  </select>

  <label>Contactabilidad:</label>
  <select id="contactabilidad">
    <option value="todos">Todos</option>
    {% for c in contactabilidades %}
    <option value="{{ c }}">{{ c }}</option>
    {% endfor %}
  </select>

  <button onclick="reiniciarUbicacion()">📍 Mi ubicación</button>
  <button onclick="limpiar()">🧹 Limpiar</button>
</div>

<div id="map"></div>
<div id="lista-clientes"><strong>Clientes cercanos:</strong></div>

<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script>
const clientes = {{ clientes|tojson }};
const map = L.map('map').setView([-12.0464, -77.0428], 13);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);

let marcadorUsuario = null;
let circulo = null;
let marcadores = {};

function limpiar() {
  Object.values(marcadores).forEach(m => map.removeLayer(m));
  marcadores = {};
  if (circulo) map.removeLayer(circulo);
  document.getElementById("lista-clientes").innerHTML = "<strong>Clientes cercanos:</strong>";
}

function colorPorPrioridad(p) {
  if (!p) return 'gray';
  p = p.toLowerCase();
  if (p === "alta") return 'red';
  if (p === "media") return 'orange';
  return 'blue';
}

function mostrarClientes(centro, radio) {
  limpiar();
  const estadoFiltro = document.getElementById("estado").value;
  const prioridadFiltro = document.getElementById("prioridad").value;
  const procesalFiltro = document.getElementById("procesal").value;
  const contactabilidadFiltro = document.getElementById("contactabilidad").value;

  let html = "<strong>Clientes cercanos:</strong>";
  let contador = 0;

  clientes.forEach(c => {
    const dist = map.distance(centro, [c.latitud, c.longitud]);
    const coincide =
      (estadoFiltro === "todos" || c.estado === estadoFiltro) &&
      (prioridadFiltro === "todos" || c.prioridad === prioridadFiltro) &&
      (procesalFiltro === "todos" || c.procesal === procesalFiltro) &&
      (contactabilidadFiltro === "todos" || c.contactabilidad === contactabilidadFiltro);

    if (dist <= radio && coincide) {
      const icono = L.icon({
        iconUrl: `https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-${colorPorPrioridad(c.prioridad)}.png`,
        shadowUrl: 'https://unpkg.com/leaflet@1.7.1/dist/images/marker-shadow.png',
        iconSize: [25, 41],
        iconAnchor: [12, 41],
        popupAnchor: [1, -34],
        shadowSize: [41, 41]
      });

      const marcador = L.marker([c.latitud, c.longitud], { icon: icono })
        .addTo(map)
        .bindPopup(`<b>${c.nombre}</b><br>${c.direccion}`);
      marcadores[c.id_deudor] = marcador;

      html += `
        <div class="cliente">
          <strong>${c.nombre}</strong><br>
          <small><b>Dirección:</b> ${c.direccion}</small><br>
          <small><b>Estado:</b> ${c.estado}</small><br>
          <small><b>Prioridad:</b> ${c.prioridad}</small><br>
          <small><b>Procesal:</b> ${c.procesal}</small><br>
          <small><b>Contactabilidad:</b> ${c.contactabilidad}</small><br>
          <button onclick="centrarEnCliente('${c.id_deudor}')">📍 Ver en el mapa</button>
        </div>`;
      contador++;
    }
  });

  if (contador === 0) html += "<p>No hay clientes en este rango.</p>";
  document.getElementById("lista-clientes").innerHTML = html;
}

function centrarEnCliente(id) {
  const marcador = marcadores[id];
  if (marcador) {
    map.setView(marcador.getLatLng(), 16);
    marcador.openPopup();
  }
}

function dibujarCirculo(centro, radio) {
  if (circulo) map.removeLayer(circulo);
  circulo = L.circle(centro, {
    radius: radio,
    color: 'blue',
    fillColor: '#3f51b5',
    fillOpacity: 0.15
  }).addTo(map);
}

function iniciarMapa() {
  navigator.geolocation.getCurrentPosition(pos => {
    const centro = [pos.coords.latitude, pos.coords.longitude];
    const radio = parseInt(document.getElementById("rango").value);
    if (marcadorUsuario) map.removeLayer(marcadorUsuario);
    marcadorUsuario = L.marker(centro).addTo(map).bindPopup("Tú estás aquí").openPopup();
    map.setView(centro, 14);
    mostrarClientes(centro, radio);
    dibujarCirculo(centro, radio);
  }, () => alert("No se pudo obtener tu ubicación."));
}

function reiniciarUbicacion() {
  iniciarMapa();
}

["rango", "estado", "prioridad", "procesal", "contactabilidad"].forEach(id => {
  document.getElementById(id).addEventListener("change", () => {
    if (marcadorUsuario) {
      const centro = marcadorUsuario.getLatLng();
      const radio = parseInt(document.getElementById("rango").value);
      mostrarClientes([centro.lat, centro.lng], radio);
      dibujarCirculo([centro.lat, centro.lng], radio);
    }
  });
});

map.on("click", function (e) {
  const centro = [e.latlng.lat, e.latlng.lng];
  const radio = parseInt(document.getElementById("rango").value);
  if (marcadorUsuario) map.removeLayer(marcadorUsuario);
  marcadorUsuario = L.marker(centro).addTo(map).bindPopup("Ubicación seleccionada").openPopup();
  mostrarClientes(centro, radio);
  dibujarCirculo(centro, radio);
});

iniciarMapa();
</script>
</body>
</html>
