<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Mapa de Clientes</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <style>
    :root {
      --color-primario: #2563EB;
      --color-secundario: #155BB5;
      --color-fondo: #FFFFFF;
      --color-texto: #1E2530;
      --color-borde: #E0E6ED;
      --color-card: #F9FAFB;
    }

    html, body {
      margin: 0;
      padding: 0;
      font-family: Arial, sans-serif;
      background-color: var(--color-fondo);
      color: var(--color-texto);
      scroll-behavior: smooth;
    }

    body::-webkit-scrollbar { width: 8px; }
    body::-webkit-scrollbar-thumb { background: rgba(0,0,0,0.2); border-radius: 5px; }

    #map {
      height: 65vh;
      margin: 10px;
      border-radius: 8px;
      position: relative;
    }

    #btn-ubicacion-mapa {
      position: absolute;
      top: 10px;
      right: 10px;
      background: rgba(255, 255, 255, 0.85);
      border: 1px solid #ccc;
      border-radius: 50%;
      width: 40px;
      height: 40px;
      text-align: center;
      line-height: 40px;
      font-size: 20px;
      cursor: pointer;
      z-index: 1000;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
      transition: background 0.2s ease;
    }

    #btn-ubicacion-mapa:hover {
      background: white;
    }

    /* ... aqu√≠ contin√∫a tu CSS existente como el top-bar, filtros, botones, etc ... */
  </style>
</head>
<body>

<!-- Aviso scroll -->
<div id="aviso-scroll">‚¨áÔ∏è Desliza para ver m√°s</div>

<!-- Bot√≥n volver arriba -->
<button id="btn-volver-arriba" onclick="window.scrollTo({ top: 0, behavior: 'smooth' });">‚¨ÜÔ∏è</button>

<!-- Top Bar -->
<div class="top-bar">
  <h3>üìç Mapa de clientes</h3>
  <a href="/logout" class="logout-btn">Cerrar sesi√≥n</a>
</div>

<!-- Filtros -->
<details id="filtros" open>
  <summary>üîç Filtros de b√∫squeda</summary>
  <div class="contenedor-filtros">
    <label>Radio:</label>
    <select id="rango">
      <option value="500">500 metros</option>
      <option value="1000">1 kil√≥metro</option>
      <option value="2000">2 kil√≥metros</option>
    </select>

    <label>Estado:</label>
    <select id="estado">
      <option value="todos">Todos</option>
      <option value="activo">Activo</option>
      <option value="no activo">No activo</option>
    </select>

    <label>Prioridad:</label>
    <select id="prioridad">
      <option value="todos">Todos</option>
      {% for p in prioridades %}
      <option value="{{ p }}">{{ p }}</option>
      {% endfor %}
    </select>

    <label>Procesal:</label>
    <select id="procesal">
      <option value="todos">Todos</option>
      {% for p in procesales %}
      <option value="{{ p }}">{{ p }}</option>
      {% endfor %}
    </select>

    <label>Contactabilidad:</label>
    <select id="contactabilidad">
      <option value="todos">Todos</option>
      {% for c in contactabilidades %}
      <option value="{{ c }}">{{ c }}</option>
      {% endfor %}
    </select>

    <label>Negocio:</label>
    <select id="negocio">
      <option value="todos">Todos</option>
      {% for n in negocios %}
      <option value="{{ n }}">{{ n }}</option>
      {% endfor %}
    </select>

    <div class="botones">
      <!-- Se elimin√≥ el bot√≥n antiguo de ubicaci√≥n aqu√≠ -->
      <button onclick="limpiar()">üßπ Limpiar</button>
    </div>
  </div>
</details>
<!-- Mapa -->
<div id="map"></div>

<!-- Bot√≥n flotante dentro del mapa -->
<div id="btn-ubicacion-mapa" onclick="reiniciarUbicacion()">üìç</div>

<!-- Lista de clientes -->
<div id="lista-clientes"><strong>Clientes cercanos:</strong></div>
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script>
const clientes = {{ clientes | tojson | safe }};
const map = L.map('map').setView([-12.0464, -77.0428], 13);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);

let marcadorUsuario = null;
let circulo = null;
let centroActual = [-12.0464, -77.0428];

function limpiar() {
  map.eachLayer(layer => {
    if (layer instanceof L.Marker && layer !== marcadorUsuario) map.removeLayer(layer);
  });
  if (circulo) map.removeLayer(circulo);
  document.getElementById("rango").selectedIndex = 0;
  document.getElementById("estado").value = "todos";
  document.getElementById("prioridad").value = "todos";
  document.getElementById("procesal").value = "todos";
  document.getElementById("contactabilidad").value = "todos";
  document.getElementById("negocio").value = "todos";
  document.getElementById("lista-clientes").innerHTML = "<strong>Clientes cercanos:</strong>";
  reiniciarUbicacion();
}

function colorPorPrioridad(p) {
  p = (p || '').toLowerCase();
  if (p === 'alta') return 'red';
  if (p === 'media') return 'orange';
  if (p === 'baja') return 'blue';
  return 'gray';
}

function mostrarClientes(centro, radio) {
  map.eachLayer(layer => {
    if (layer instanceof L.Marker && layer !== marcadorUsuario) map.removeLayer(layer);
  });
  if (circulo) map.removeLayer(circulo);
  centroActual = centro;

  const estado = document.getElementById("estado").value.toLowerCase();
  const prioridad = document.getElementById("prioridad").value.toLowerCase();
  const procesal = document.getElementById("procesal").value.toLowerCase();
  const contactabilidad = document.getElementById("contactabilidad").value.toLowerCase();
  const negocio = document.getElementById("negocio").value.toLowerCase();

  let html = "<strong>Clientes cercanos:</strong>";
  let contador = 0;

  clientes.forEach(c => {
    const lat = Number(c.latitud);
    const lng = Number(c.longitud);
    if (!lat || !lng || isNaN(lat) || isNaN(lng)) return;

    const dist = map.distance(centro, [lat, lng]);
    const coincide =
      (estado === "todos" || (c.estado || '').toLowerCase() === estado) &&
      (prioridad === "todos" || (c.prioridad || '').toLowerCase() === prioridad) &&
      (procesal === "todos" || (c.procesal || '').toLowerCase() === procesal) &&
      (contactabilidad === "todos" || (c.contactabilidad || '').toLowerCase() === contactabilidad) &&
      (negocio === "todos" || (c.negocio || '').toLowerCase() === negocio);

    if (dist <= radio && coincide) {
      const icono = L.icon({
        iconUrl: `https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-${colorPorPrioridad(c.prioridad)}.png`,
        shadowUrl: 'https://unpkg.com/leaflet@1.7.1/dist/images/marker-shadow.png',
        iconSize: [25, 41],
        iconAnchor: [12, 41],
        popupAnchor: [1, -34],
        shadowSize: [41, 41]
      });

      L.marker([lat, lng], { icon: icono })
        .addTo(map)
        .bindPopup(`<b>${c.nombre}</b><br>${c.direccion || ''}`);

      html += `
        <div class="cliente">
          <b>${c.nombre}</b><br>
          <p><strong>ID Deudor:</strong> ${c.id_deudor || '-'}</p>
          <p><strong>Direcci√≥n:</strong> ${c.direccion || ''}, ${c.distrito || ''}</p>
          <p><strong>Prioridad:</strong> ${c.prioridad || '-'}</p>
          <p><strong>Procesal:</strong> ${c.procesal || '-'}</p>
          <p><strong>Contactabilidad:</strong> ${c.contactabilidad || '-'}</p>
          <p><strong>Negocio:</strong> ${c.negocio || '-'}</p>
          <p><strong>Asesor:</strong> ${c.asesor || '-'}</p>
          <p><strong>Tel√©fono Asesor:</strong> ${c.nro_asesor || '-'}</p>
          <button onclick="centrarEnCliente(${lat}, ${lng})">üìç Ver en el mapa</button>
        </div>`;
      contador++;
    }
  });

  if (contador === 0) html += "<p>Sin resultados dentro del radio.</p>";
  document.getElementById("lista-clientes").innerHTML = html;
  dibujarCirculo(centro, radio);
}

function centrarEnCliente(lat, lng) {
  map.setView([lat, lng], 16);
}

function dibujarCirculo(centro, radio) {
  if (circulo) map.removeLayer(circulo);
  circulo = L.circle(centro, {
    radius: radio,
    color: '#2563EB',
    fillColor: '#2563EB',
    fillOpacity: 0.2
  }).addTo(map);
}

function iniciarMapa() {
  navigator.geolocation.getCurrentPosition(pos => {
    const centro = [pos.coords.latitude, pos.coords.longitude];
    const radio = parseInt(document.getElementById("rango").value);

    if (marcadorUsuario) map.removeLayer(marcadorUsuario);
    marcadorUsuario = L.marker(centro).addTo(map).bindPopup("T√∫ est√°s aqu√≠").openPopup();
    map.setView(centro, 14);
    mostrarClientes(centro, radio);

    fetch('/guardar-ubicacion', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ latitud: centro[0], longitud: centro[1] })
    }).then(res => console.log("üì§ Ubicaci√≥n enviada", res.status))
      .catch(err => console.error("‚ùå Error al enviar ubicaci√≥n", err));

  }, () => {
    alert("No se pudo obtener tu ubicaci√≥n.");
  });
}

function reiniciarUbicacion() {
  iniciarMapa();
}

["rango", "estado", "prioridad", "procesal", "contactabilidad", "negocio"].forEach(id => {
  document.getElementById(id).addEventListener("change", () => {
    const radio = parseInt(document.getElementById("rango").value);
    mostrarClientes(centroActual, radio);
  });
});

map.on("click", e => {
  const centro = [e.latlng.lat, e.latlng.lng];
  const radio = parseInt(document.getElementById("rango").value);
  if (marcadorUsuario) map.removeLayer(marcadorUsuario);
  marcadorUsuario = L.marker(centro).addTo(map).bindPopup("Ubicaci√≥n seleccionada").openPopup();
  mostrarClientes(centro, radio);
});

iniciarMapa();

window.addEventListener('scroll', () => {
  const btn = document.getElementById('btn-volver-arriba');
  const aviso = document.getElementById('aviso-scroll');
  if (window.scrollY > 300) btn.classList.add('show');
  else btn.classList.remove('show');
  if (window.scrollY > 100 && aviso) aviso.style.display = 'none';
});
</script>
</body>
</html>
